name: Build Windows

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
  workflow_call:  # Allow this workflow to be called by other workflows

jobs:
  build:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.38.7'
        channel: 'stable'
        
    - name: Install dependencies
      run: flutter pub get
    
    - name: Ensure resources directory exists
      run: |
        if not exist windows\runner\resources (
          mkdir windows\runner\resources
        )
      shell: cmd

    - name: Prepare Windows icon
      run: |
        choco install imagemagick -y
        magick convert icons/64x64.png icons/128x128.png icons/256x256.png windows/runner/resources/app_icon.ico
      
    - name: Build Windows app
      run: flutter build windows --release
      
    - name: Create ZIP package
      run: |
        cd build/windows/x64/runner/Release
        Compress-Archive -Path * -DestinationPath ../../../../../expeditiousreader-windows-x64.zip
        cd ../../../../../
      
    - name: Upload Windows artifact
      uses: actions/upload-artifact@v4
      with:
        name: windows-build
        path: expeditiousreader-windows-x64.zip
        retention-days: 30